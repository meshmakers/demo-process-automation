name: $(MajorVersion).$(MinorVersion).$(date:yyMM).$(DayOfMonth)$(rev:rrr)-$(Build.SourceBranchName)

trigger:
  batch: true
  branches:
    include:
      - dev/*
      - test/*
      - main
  tags:
    exclude:
      - '*'

variables:
  - group: GitSSHGroup
  - group: ApiKeys-mm-cloud
  - group: OctoDefault
  - name: solutionFile
    value: 'Octo.Template.sln'
  - name: artifactsFrameworkVersion
    value: 'net9.0'
  - name: buildConfiguration
    value: 'Release'
  - name: buildPlatform
    value: 'Any CPU'
  - name: isRelease
    value: ${{ startsWith(variables['Build.SourceBranch'], 'refs/tags/r') }}
  - name: isMain
    value: ${{ eq(variables['Build.SourceBranch'], 'refs/heads/main') }}
  - name: isTest
    value: ${{ startsWith(variables['Build.SourceBranch'], 'refs/heads/test') }}
    
stages:
  - stage: Build
    jobs:
      - job: linux
        displayName: Docker build
        pool:
          name: meshmakers-ci-agents
        steps:
          - template: update-build-number.yml
          - checkout: self
            clean: true
            submodules: recursive
          - task: InstallSSHKey@0
            inputs:
              knownHostsEntry: '$(SSHKnownHosts)'
              sshPublicKey: '$(SSHPublicKey)'
              sshPassphrase: '$(SSHPassphrase)'
              sshKeySecureFile: '$(SSHPrivateKeyFile)'
          - template: set-version.yml
          - template: download-ca.yml
          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet packages'
            inputs:
              command: 'restore'
              projects: '$(SolutionFile)'
              restoreArguments: '--force /p:OctoNugetPrivateServer=$(nugetPrivateServer)'
              noCache: true
          - task: DotNetCoreCLI@2
            displayName: 'Test'
            inputs:
              command: 'test'
              projects: |
                '**/*Tests.csproj'
                !'**/*SystemTests.csproj'
              testRunTitle: 'CI'
#          - template: build-and-push-docker-image.yml
#            parameters:
#              PublicRegistryServiceConnection: $(DockerRegistryPublicAcrConnection)
#              PrivateRegistryName: $(DockerRegistryPrivateUri)
#              PublicRegistryName: $(DockerRegistryInternalUri)
#              Repository: meshmakers/octo-template
#              Dockerfile: src/Template/Dockerfile
          - template: handle-artifacts.yml
 

